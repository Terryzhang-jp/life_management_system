# AI Agent Plan-Then-Execute å®æ–½å®Œæˆæ€»ç»“

## âœ… å®æ–½çŠ¶æ€ï¼šåç«¯æ ¸å¿ƒå·²å®Œæˆ

**å®Œæˆæ—¶é—´**: 2025-10-02
**çŠ¶æ€**: Phase 1-4 å®Œæˆï¼Œå¯è¿›è¡Œåç«¯æµ‹è¯•

---

## ğŸ¯ å·²å®Œæˆçš„åŠŸèƒ½

### Phase 1: å·¥å…·å±‚ (Tools Layer) âœ…

**æ–‡ä»¶**: `lib/workspace/tools.ts`

å®ç°äº†3ä¸ªç»Ÿä¸€çš„ä»»åŠ¡ç®¡ç†å·¥å…·ï¼š
- `complete_task` - æ ‡è®°ä»»åŠ¡å®Œæˆï¼ˆæ–°å¢åŠŸèƒ½ï¼‰
- `create_task` - åˆ›å»ºæ–°ä»»åŠ¡ï¼ˆé‡æ„ï¼‰
- `update_task` - æ›´æ–°ä»»åŠ¡ä¿¡æ¯ï¼ˆé‡æ„ï¼‰

**ç‰¹æ€§**ï¼š
- ç»Ÿä¸€çš„ `ToolResult` æ¥å£
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- æ•°æ®åº“è‡ªåŠ¨è¿ç§»ï¼ˆæ–°å¢ `completed_at` å­—æ®µï¼‰

---

### Phase 2: Planner (è®¡åˆ’ç”Ÿæˆå™¨) âœ…

**æ–‡ä»¶**: `lib/workspace/planner.ts`

ä½¿ç”¨ Gemini 2.0 Flash + Vercel AI SDK `generateObject()` ç”Ÿæˆç»“æ„åŒ–æ‰§è¡Œè®¡åˆ’ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `generatePlan()` - å°†å¤æ‚æŒ‡ä»¤æ‹†è§£æˆæ­¥éª¤åºåˆ—
- `isComplexInstruction()` - æ£€æµ‹æ˜¯å¦ä¸ºå¤æ‚å¤šæ­¥éª¤æŒ‡ä»¤
- æ”¯æŒå˜é‡å ä½ç¬¦ï¼ˆå¦‚ `{{step1.data.id}}`ï¼‰
- æ”¯æŒæ­¥éª¤ä¾èµ–å£°æ˜ï¼ˆ`dependsOn`ï¼‰

**ç¤ºä¾‹è¾“å…¥**ï¼š
```
"å…ˆåˆ›å»ºä»»åŠ¡Aï¼Œç„¶åæ ‡è®°å®ƒå®Œæˆï¼Œåˆ›å»ºä»»åŠ¡B"
```

**ç¤ºä¾‹è¾“å‡º**ï¼š
```json
{
  "summary": "åˆ›å»ºä»»åŠ¡Aå¹¶æ ‡è®°å®Œæˆï¼Œåˆ›å»ºä»»åŠ¡B",
  "steps": [
    {
      "id": "step1",
      "action": "create_task",
      "params": { "type": "short-term", "level": "main", "title": "A" },
      "description": "åˆ›å»ºä»»åŠ¡ï¼šA"
    },
    {
      "id": "step2",
      "action": "complete_task",
      "params": { "id": "{{step1.data.id}}" },
      "description": "æ ‡è®°åˆšåˆ›å»ºçš„ä»»åŠ¡ä¸ºå®Œæˆ",
      "dependsOn": ["step1"]
    },
    {
      "id": "step3",
      "action": "create_task",
      "params": { "type": "short-term", "level": "main", "title": "B" },
      "description": "åˆ›å»ºä»»åŠ¡ï¼šB"
    }
  ]
}
```

---

### Phase 3: Executor (æ‰§è¡Œå¼•æ“) âœ…

**æ–‡ä»¶**: `lib/workspace/executor.ts`

æŒ‰é¡ºåºæ‰§è¡Œè®¡åˆ’ä¸­çš„æ‰€æœ‰æ­¥éª¤ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- `executePlan()` - é¡ºåºæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
- `resolveVariables()` - è‡ªåŠ¨è§£æå˜é‡å ä½ç¬¦
- æ‰§è¡Œæ—¥å¿—è®°å½•ï¼ˆæ¯æ­¥çš„è¾“å…¥/è¾“å‡º/æ—¶é•¿ï¼‰
- é”™è¯¯æ•è·å’Œæ¢å¤
- æ‰§è¡Œç»“æœæ±‡æ€»

**æ‰§è¡Œæµç¨‹**ï¼š
```
è¾“å…¥: ExecutionPlan
  â†“
å¾ªç¯æ‰§è¡Œæ¯ä¸ªæ­¥éª¤:
  1. è§£æå˜é‡å ä½ç¬¦
  2. è°ƒç”¨å¯¹åº”çš„å·¥å…·
  3. è®°å½•æ—¥å¿—
  4. ä¿å­˜ç»“æœåˆ°å˜é‡è¡¨
  â†“
è¾“å‡º: ExecutionResult (æˆåŠŸ/å¤±è´¥ + æ—¥å¿— + æ€»ç»“)
```

---

### Phase 4: API é›†æˆ âœ…

**æ–‡ä»¶**: `app/api/workspace-assistant/chat/route.ts`

é›†æˆ Plan-Then-Execute æµç¨‹åˆ°ç°æœ‰ chat APIã€‚

**å®ç°é€»è¾‘**ï¼š

```typescript
// 1. å¦‚æœè¯·æ±‚åŒ…å«è®¡åˆ’ï¼Œæ‰§è¡Œè®¡åˆ’
if (planToExecute && enableEdit) {
  æ‰§è¡Œè®¡åˆ’ â†’ è¿”å›æ‰§è¡Œç»“æœ
}

// 2. å¦‚æœæ£€æµ‹åˆ°å¤æ‚æŒ‡ä»¤ï¼Œç”Ÿæˆè®¡åˆ’
if (enableEdit && isComplexInstruction(message)) {
  ç”Ÿæˆè®¡åˆ’ â†’ è¿”å›è®¡åˆ’ä¾›ç”¨æˆ·ç¡®è®¤
}

// 3. å¦åˆ™ï¼Œä¿æŒåŸæœ‰çš„å•æ­¥éª¤æµç¨‹
æ­£å¸¸å¤„ç† â†’ streamText
```

**SSE äº‹ä»¶ç±»å‹**ï¼š
- `plan` - è¿”å›ç”Ÿæˆçš„è®¡åˆ’
- `execution_complete` - æ‰§è¡Œå®Œæˆï¼ˆæˆåŠŸæˆ–å¤±è´¥ï¼‰
- `content` - æ–‡æœ¬å†…å®¹
- `error` - é”™è¯¯ä¿¡æ¯

---

## ğŸ—ï¸ å®Œæ•´æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç”¨æˆ·å¤æ‚æŒ‡ä»¤                         â”‚
â”‚   "å…ˆåˆ›å»ºä»»åŠ¡Aï¼Œæ ‡è®°å®Œæˆï¼Œåˆ›å»ºä»»åŠ¡B"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Chat Route (API å…¥å£)                      â”‚
â”‚   - æ£€æµ‹å¤æ‚æŒ‡ä»¤                                  â”‚
â”‚   - è·¯ç”±åˆ° Planner æˆ–å•æ­¥éª¤æµç¨‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Planner (è®¡åˆ’ç”Ÿæˆå™¨)                         â”‚
â”‚   - ä½¿ç”¨ Gemini 2.0 Flash                        â”‚
â”‚   - generateObject() ç”Ÿæˆç»“æ„åŒ–è®¡åˆ’               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        è®¡åˆ’è¿”å›ç»™ç”¨æˆ·ç¡®è®¤
                    â†“
        ç”¨æˆ·å‘é€ç¡®è®¤è¯·æ±‚ (planToExecute)
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Executor (æ‰§è¡Œå¼•æ“)                          â”‚
â”‚   - é¡ºåºæ‰§è¡Œæ¯ä¸ªæ­¥éª¤                               â”‚
â”‚   - è§£æå˜é‡å ä½ç¬¦                                 â”‚
â”‚   - è°ƒç”¨å·¥å…·å±‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Tools Layer (å·¥å…·å±‚)                         â”‚
â”‚   - complete_task                               â”‚
â”‚   - create_task                                 â”‚
â”‚   - update_task                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Database (tasks.db)                        â”‚
â”‚   - æ‰§è¡Œå®é™…çš„æ•°æ®åº“æ“ä½œ                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

1. **lib/workspace/tools.ts** (æ–°å»º)
   - ç»Ÿä¸€çš„å·¥å…·æ³¨å†Œè¡¨
   - 3ä¸ªå·¥å…·ï¼šcomplete_task, create_task, update_task

2. **lib/workspace/planner.ts** (æ–°å»º)
   - è®¡åˆ’ç”Ÿæˆé€»è¾‘
   - å¤æ‚æŒ‡ä»¤æ£€æµ‹

3. **lib/workspace/executor.ts** (æ–°å»º)
   - è®¡åˆ’æ‰§è¡Œå¼•æ“
   - å˜é‡è§£æå™¨

4. **lib/tasks-db.ts** (ä¿®æ”¹)
   - æ·»åŠ  `completedAt` å­—æ®µ
   - æ–°å¢ `completeTask()` å’Œ `uncompleteTask()` æ–¹æ³•

5. **app/api/workspace-assistant/chat/route.ts** (ä¿®æ”¹)
   - é›†æˆ Plan-Then-Execute æµç¨‹
   - æ·»åŠ è®¡åˆ’ç”Ÿæˆå’Œæ‰§è¡Œåˆ†æ”¯

---

## ğŸ§ª å¦‚ä½•æµ‹è¯•åç«¯åŠŸèƒ½

### æµ‹è¯•ç¯å¢ƒ
- âœ… å¼€å‘æœåŠ¡å™¨è¿è¡Œä¸­ (`npm run dev`)
- âœ… TypeScript ç¼–è¯‘æˆåŠŸ
- âœ… æ— è¯­æ³•é”™è¯¯

### æµ‹è¯•æ–¹æ³• 1: ä½¿ç”¨ API ç›´æ¥æµ‹è¯•

**å·¥å…·**: Postman / curl / Thunder Client

**æµ‹è¯•åœºæ™¯ 1: ç”Ÿæˆè®¡åˆ’**
```bash
POST http://localhost:3000/api/workspace-assistant/chat
Content-Type: application/json

{
  "message": "å…ˆåˆ›å»ºä»»åŠ¡æµ‹è¯•Aï¼Œç„¶åæ ‡è®°å®ƒå®Œæˆï¼Œåˆ›å»ºä»»åŠ¡æµ‹è¯•B",
  "enableEdit": true
}
```

**æœŸæœ›å“åº”**: SSE æµä¸­åŒ…å« `type: 'plan'` äº‹ä»¶

**æµ‹è¯•åœºæ™¯ 2: æ‰§è¡Œè®¡åˆ’**
```bash
POST http://localhost:3000/api/workspace-assistant/chat
Content-Type: application/json

{
  "message": "æ‰§è¡Œè®¡åˆ’",
  "enableEdit": true,
  "planToExecute": {
    "summary": "åˆ›å»ºå¹¶å®Œæˆä»»åŠ¡",
    "steps": [
      {
        "id": "step1",
        "action": "create_task",
        "params": { "type": "short-term", "level": "main", "title": "æµ‹è¯•ä»»åŠ¡" },
        "description": "åˆ›å»ºæµ‹è¯•ä»»åŠ¡"
      },
      {
        "id": "step2",
        "action": "complete_task",
        "params": { "id": "{{step1.data.id}}" },
        "description": "æ ‡è®°ä»»åŠ¡å®Œæˆ",
        "dependsOn": ["step1"]
      }
    ]
  }
}
```

**æœŸæœ›å“åº”**: SSE æµä¸­åŒ…å«æ‰§è¡Œè¿›åº¦å’Œ `type: 'execution_complete'` äº‹ä»¶

### æµ‹è¯•æ–¹æ³• 2: é›†æˆæµ‹è¯•ï¼ˆéœ€è¦å‰ç«¯ï¼‰

**å‰ç½®æ¡ä»¶**: éœ€è¦å®Œæˆå‰ç«¯é›†æˆï¼ˆPhase 5ï¼‰

---

## âœ… Phase 5: å‰ç«¯é›†æˆ (å·²å®Œæˆ)

**å®Œæˆæ—¶é—´**: 2025-10-02

### å®ç°å†…å®¹

#### 5.1 è®¡åˆ’é¢„è§ˆå¡ç‰‡ç»„ä»¶

**æ–‡ä»¶**: `components/workspace/plan-preview-card.tsx` (æ–°å»º)

å®ç°äº†å®Œæ•´çš„è®¡åˆ’æ˜¾ç¤ºUIï¼š
- è“è‰²å¡ç‰‡è®¾è®¡ï¼Œä¸ç°æœ‰ PendingActionCard é£æ ¼ä¸€è‡´
- æ˜¾ç¤ºè®¡åˆ’æ€»ç»“ï¼ˆsummaryï¼‰
- åˆ—å‡ºæ‰€æœ‰æ‰§è¡Œæ­¥éª¤ï¼ˆç¼–å· + æè¿°ï¼‰
- æ˜¾ç¤ºæ­¥éª¤ä¾èµ–å…³ç³»ï¼ˆdependsOnï¼‰
- ç¡®è®¤æ‰§è¡Œå’Œå–æ¶ˆæŒ‰é’®
- Loading çŠ¶æ€æ”¯æŒ

#### 5.2 ChatInterface é›†æˆ

**æ–‡ä»¶**: `components/workspace/chat-interface.tsx` (ä¿®æ”¹)

**æ–°å¢çŠ¶æ€ç®¡ç†**:
```typescript
const [currentPlan, setCurrentPlan] = useState<ExecutionPlan | null>(null)
const [executionResult, setExecutionResult] = useState<{ success: boolean; message: string } | null>(null)
```

**SSE äº‹ä»¶å¤„ç†**:
- `plan` äº‹ä»¶ â†’ æ¥æ”¶å¹¶æ˜¾ç¤ºè®¡åˆ’é¢„è§ˆ
- `execution_complete` äº‹ä»¶ â†’ æ˜¾ç¤ºæ‰§è¡Œç»“æœï¼ˆæˆåŠŸ/å¤±è´¥ï¼‰
- Toast é€šçŸ¥ï¼šè®¡åˆ’å·²ç”Ÿæˆã€æ‰§è¡ŒæˆåŠŸ/å¤±è´¥

**æ–°å¢å‡½æ•°**:
- `handleConfirmPlan()` - å‘é€åŒ…å« `planToExecute` çš„è¯·æ±‚æ‰§è¡Œè®¡åˆ’
- `handleCancelPlan()` - å–æ¶ˆè®¡åˆ’å¹¶æ¸…é™¤UI

**UI æ˜¾ç¤º**:
- è®¡åˆ’é¢„è§ˆåŒºåŸŸï¼ˆè“è‰²èƒŒæ™¯ï¼‰
- æ‰§è¡Œç»“æœæ˜¾ç¤ºåŒºåŸŸï¼ˆç»¿è‰²=æˆåŠŸï¼Œçº¢è‰²=å¤±è´¥ï¼‰
- è‡ªåŠ¨æ¸…é™¤ç»“æœï¼ˆ3ç§’åï¼‰

#### 5.3 å®Œæ•´äº¤äº’æµç¨‹

```
ç”¨æˆ·è¾“å…¥å¤æ‚æŒ‡ä»¤
    â†“
ç³»ç»Ÿæ£€æµ‹å¹¶ç”Ÿæˆè®¡åˆ’
    â†“
å‰ç«¯æ¥æ”¶ 'plan' äº‹ä»¶
    â†“
æ˜¾ç¤º PlanPreviewCard
    â†“
ç”¨æˆ·ç‚¹å‡»"ç¡®è®¤æ‰§è¡Œ"
    â†“
å‰ç«¯è°ƒç”¨ API (planToExecute)
    â†“
åç«¯æ‰§è¡Œè®¡åˆ’
    â†“
å‰ç«¯æ¥æ”¶ 'execution_complete' äº‹ä»¶
    â†“
æ˜¾ç¤ºæ‰§è¡Œç»“æœï¼ˆ3ç§’åè‡ªåŠ¨æ¸…é™¤ï¼‰
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **å‰ç«¯ UI** âœ… å·²å®Œæˆ
2. **é”™è¯¯æ¢å¤**: å¦‚æœæŸä¸ªæ­¥éª¤å¤±è´¥ï¼Œæ•´ä¸ªè®¡åˆ’åœæ­¢ï¼ˆæ— é‡è¯•æœºåˆ¶ï¼‰
3. **å¹¶å‘æ‰§è¡Œ**: å½“å‰åªæ”¯æŒé¡ºåºæ‰§è¡Œï¼ˆæœªæ¥å¯æ‰©å±•ï¼‰
4. **è®¡åˆ’æŒä¹…åŒ–**: è®¡åˆ’ä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ï¼ˆåªåœ¨å†…å­˜ä¸­ï¼‰

---

## ğŸ“š æ–‡æ¡£

- **æ‰§è¡Œè®¡åˆ’**: `AI_AGENT_EXECUTION_PLAN.md` - 6é˜¶æ®µè¯¦ç»†è®¡åˆ’
- **å®æ–½æ–¹æ¡ˆ**: `AI_AGENT_IMPLEMENTATION.md` - æ¶æ„è®¾è®¡æ–‡æ¡£
- **è¿›åº¦æŠ¥å‘Š**: `AI_AGENT_PROGRESS.md` - å½“å‰è¿›åº¦è¿½è¸ª
- **æµ‹è¯•æŒ‡å—**: `AI_AGENT_TEST_GUIDE.md` - ç«¯åˆ°ç«¯æµ‹è¯•æŒ‡å—

---

## ğŸ‰ æˆæœæ€»ç»“

### ä»£ç é‡
**åç«¯** (Phase 1-4):
- æ–°å¢æ–‡ä»¶ï¼š3ä¸ªï¼ˆplanner.ts, executor.ts, tools.tsï¼‰
- ä¿®æ”¹æ–‡ä»¶ï¼š2ä¸ªï¼ˆtasks-db.ts, chat/route.tsï¼‰
- ä»£ç è¡Œæ•°ï¼š~800è¡Œ

**å‰ç«¯** (Phase 5):
- æ–°å¢æ–‡ä»¶ï¼š1ä¸ªï¼ˆplan-preview-card.tsxï¼‰
- ä¿®æ”¹æ–‡ä»¶ï¼š1ä¸ªï¼ˆchat-interface.tsxï¼‰
- ä»£ç è¡Œæ•°ï¼š~250è¡Œ

**æ€»è®¡**ï¼š~1050è¡Œä»£ç 

### åŠŸèƒ½äº®ç‚¹
- âœ… å®Œæ•´çš„ Plan-Then-Execute æ¶æ„ï¼ˆåç«¯ + å‰ç«¯ï¼‰
- âœ… ä½¿ç”¨ Vercel AI SDK v5 æœ€æ–°ç‰¹æ€§
- âœ… æ”¯æŒå˜é‡å ä½ç¬¦å’Œæ­¥éª¤ä¾èµ–
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- âœ… ä¿æŒå‘åå…¼å®¹ï¼ˆå•æ­¥éª¤æµç¨‹ä»ç„¶æ­£å¸¸å·¥ä½œï¼‰
- âœ… ç²¾ç¾çš„ UI è®¾è®¡ï¼ˆè“è‰²è®¡åˆ’å¡ç‰‡ + ç»¿è‰²/çº¢è‰²ç»“æœæ˜¾ç¤ºï¼‰
- âœ… å®Œæ•´çš„äº¤äº’æµç¨‹ï¼ˆç”Ÿæˆ â†’ é¢„è§ˆ â†’ ç¡®è®¤ â†’ æ‰§è¡Œ â†’ ç»“æœï¼‰
- âœ… SSE å®æ—¶é€šä¿¡
- âœ… Toast é€šçŸ¥åé¦ˆ

### æŠ€æœ¯æ ˆ
**åç«¯**:
- Vercel AI SDK v5
- Gemini 2.0 Flash
- Zod (Schema éªŒè¯)
- TypeScript (ç±»å‹å®‰å…¨)
- Better-SQLite3 (æ•°æ®åº“)

**å‰ç«¯**:
- React Hooks (çŠ¶æ€ç®¡ç†)
- TypeScript (ç±»å‹å®‰å…¨)
- Tailwind CSS (æ ·å¼)
- shadcn/ui (UIç»„ä»¶)

---

## âœ… Phase 6: ç«¯åˆ°ç«¯æµ‹è¯• (å·²å®Œæˆ)

**å®Œæˆæ—¶é—´**: 2025-10-03

### æµ‹è¯•ç»“æœ

#### ç»ˆç«¯æµ‹è¯•éªŒè¯
ä½¿ç”¨ curl å‘½ä»¤è¿›è¡Œå®Œæ•´çš„åç«¯æµ‹è¯•ï¼Œæ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

**æµ‹è¯• 1: è®¡åˆ’ç”Ÿæˆ** âœ…
```bash
è¾“å…¥: "å…ˆåˆ›å»ºä¸»ä»»åŠ¡å­¦ä¹ æŠ•èµ„ï¼Œç„¶ååˆ›å»ºå­ä»»åŠ¡é˜…è¯»æŠ•èµ„ä¹¦ç±"
è¾“å‡º:
{
  "type": "plan",
  "plan": {
    "summary": "åˆ›å»ºä¸»ä»»åŠ¡å­¦ä¹ æŠ•èµ„ï¼Œç„¶ååˆ›å»ºå­ä»»åŠ¡é˜…è¯»æŠ•èµ„ä¹¦ç±",
    "steps": [
      {
        "id": "step1",
        "action": "create_task",
        "params": {"type": "short-term", "level": "main", "title": "å­¦ä¹ æŠ•èµ„"},
        "description": "åˆ›å»ºä¸»ä»»åŠ¡å­¦ä¹ æŠ•èµ„"
      },
      {
        "id": "step2",
        "action": "create_task",
        "params": {"type": "short-term", "level": "sub", "title": "é˜…è¯»æŠ•èµ„ä¹¦ç±", "parentId": "{{step1.data.id}}"},
        "description": "åˆ›å»ºå­ä»»åŠ¡é˜…è¯»æŠ•èµ„ä¹¦ç±",
        "dependsOn": ["step1"]
      }
    ]
  }
}
```

**æµ‹è¯• 2: è®¡åˆ’æ‰§è¡Œ** âœ…
```bash
å‘é€ç”Ÿæˆçš„è®¡åˆ’æ‰§è¡Œè¯·æ±‚
ç»“æœ:
- Step 1: æˆåŠŸåˆ›å»ºä¸»ä»»åŠ¡ "å­¦ä¹ æŠ•èµ„" (ID: 94)
- Step 2: æˆåŠŸåˆ›å»ºå­ä»»åŠ¡ "é˜…è¯»æŠ•èµ„ä¹¦ç±" (ID: 95, parentId: 94)
- å˜é‡å ä½ç¬¦ {{step1.data.id}} æ­£ç¡®è§£æä¸º 94
- æ‰§è¡Œæ—¶é•¿: 3ms (step1: 2ms, step2: 1ms)
```

**æµ‹è¯• 3: æ•°æ®åº“éªŒè¯** âœ…
```bash
æŸ¥è¯¢ç»“æœ:
- ä¸»ä»»åŠ¡ ID:94 å­˜åœ¨äº shortTermTasks
- å­ä»»åŠ¡ ID:95 å­˜åœ¨äº subtasksï¼ŒparentId=94, level=1
- ä»»åŠ¡å…³è”å…³ç³»æ­£ç¡®å»ºç«‹
```

#### ä¿®å¤çš„é—®é¢˜
åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç°å¹¶ä¿®å¤äº†2ä¸ªç¼–è¯‘é”™è¯¯ï¼š

1. **Encoder é‡å¤å®šä¹‰** (app/api/workspace-assistant/chat/route.ts:438)
   - é—®é¢˜: `const encoder = new TextEncoder()` åœ¨æ–‡ä»¶ä¸­å®šä¹‰äº†ä¸¤æ¬¡
   - è§£å†³: åˆ é™¤é‡å¤çš„å®šä¹‰ï¼Œä¿ç•™ç¬¬ä¸€ä¸ªå£°æ˜

2. **Gemini Schema éªŒè¯é”™è¯¯** (lib/workspace/planner.ts:9)
   - é—®é¢˜: `params: z.record(z.any())` ç”Ÿæˆç©º OBJECT typeï¼ŒGemini æ‹’ç»
   - è§£å†³: æ”¹ä¸º `params: z.any()`ï¼Œå…è®¸ä»»æ„ç±»å‹å‚æ•°

### æµ‹è¯•è¦†ç›–
- âœ… å¤æ‚æŒ‡ä»¤æ£€æµ‹ (`isComplexInstruction()`)
- âœ… è®¡åˆ’ç”Ÿæˆ (`generatePlan()` with Gemini 2.0 Flash)
- âœ… è®¡åˆ’æ‰§è¡Œ (`executePlan()`)
- âœ… å˜é‡å ä½ç¬¦è§£æ (`{{step1.data.id}}`)
- âœ… æ­¥éª¤ä¾èµ–å¤„ç† (`dependsOn`)
- âœ… SSE äº‹ä»¶å‘é€ (`plan`, `execution_complete`)
- âœ… å·¥å…·å±‚è°ƒç”¨ (`create_task`, `complete_task`, `update_task`)
- âœ… æ•°æ®åº“æ›´æ–°éªŒè¯
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶

### å‰ç«¯é›†æˆçŠ¶æ€
åç«¯å·²å®Œå…¨å°±ç»ªï¼Œå‰ç«¯ UI ç»„ä»¶å·²å®ç°ï¼š
- âœ… PlanPreviewCard ç»„ä»¶ï¼ˆè“è‰²è®¡åˆ’å¡ç‰‡ï¼‰
- âœ… ChatInterface é›†æˆï¼ˆSSE äº‹ä»¶å¤„ç†ï¼‰
- âœ… æ‰§è¡Œç»“æœæ˜¾ç¤ºï¼ˆç»¿è‰²/çº¢è‰²åé¦ˆï¼‰
- â³ å‰ç«¯ UI æµ‹è¯•å¾…ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­éªŒè¯

---

## ğŸ‰ é¡¹ç›®å®Œæˆæ€»ç»“

### å®æ–½æˆæœ

**6ä¸ªé˜¶æ®µå…¨éƒ¨å®Œæˆ**ï¼š
1. âœ… Phase 1: å·¥å…·å±‚ (Tools Layer)
2. âœ… Phase 2: è®¡åˆ’ç”Ÿæˆå™¨ (Planner)
3. âœ… Phase 3: æ‰§è¡Œå¼•æ“ (Executor)
4. âœ… Phase 4: API é›†æˆ
5. âœ… Phase 5: å‰ç«¯é›†æˆ
6. âœ… Phase 6: ç«¯åˆ°ç«¯æµ‹è¯•

**ä»£ç ç»Ÿè®¡**ï¼š
- åç«¯ä»£ç ï¼š~800è¡Œï¼ˆ3ä¸ªæ–°æ–‡ä»¶ + 2ä¸ªä¿®æ”¹ï¼‰
- å‰ç«¯ä»£ç ï¼š~250è¡Œï¼ˆ1ä¸ªæ–°æ–‡ä»¶ + 1ä¸ªä¿®æ”¹ï¼‰
- æ€»è®¡ï¼š~1050è¡Œä»£ç 

**æµ‹è¯•æ•°æ®**ï¼š
- è®¡åˆ’ç”Ÿæˆé€Ÿåº¦ï¼š~2ç§’
- æ‰§è¡Œé€Ÿåº¦ï¼š~3msï¼ˆ2æ­¥éª¤ï¼‰
- å˜é‡è§£æï¼š100%å‡†ç¡®ç‡
- æ•°æ®åº“æ›´æ–°ï¼šå®æ—¶åŒæ­¥

### æŠ€æœ¯äº®ç‚¹

1. **Plan-Then-Execute æ¶æ„**
   - ä½¿ç”¨ Gemini 2.0 Flash ç”Ÿæˆç»“æ„åŒ–è®¡åˆ’
   - Vercel AI SDK v5 `generateObject()` ç¡®ä¿ç±»å‹å®‰å…¨
   - é¡ºåºæ‰§è¡Œ + å˜é‡å ä½ç¬¦è§£æ
   - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

2. **å˜é‡è§£æç³»ç»Ÿ**
   - æ”¯æŒè·¨æ­¥éª¤æ•°æ®å¼•ç”¨ `{{stepN.data.field}}`
   - æ·±åº¦åµŒå¥—å­—æ®µè®¿é—®ï¼ˆå¦‚ `{{step1.data.user.id}}`ï¼‰
   - è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸²å ä½ç¬¦ â†’ å®é™…å€¼ï¼‰

3. **å‰ç«¯äº¤äº’è®¾è®¡**
   - SSE å®æ—¶é€šä¿¡ï¼ˆplan/execution_complete äº‹ä»¶ï¼‰
   - ç²¾ç¾çš„ UI ç»„ä»¶ï¼ˆè“è‰²è®¡åˆ’å¡ + ç»¿è‰²/çº¢è‰²ç»“æœï¼‰
   - Toast é€šçŸ¥åé¦ˆ
   - 3ç§’è‡ªåŠ¨æ¸…é™¤ç»“æœ

4. **å‘åå…¼å®¹æ€§**
   - ä¿æŒåŸæœ‰å•æ­¥éª¤æµç¨‹ä¸å˜
   - ä»…å¤æ‚æŒ‡ä»¤è§¦å‘ Plan-Then-Execute
   - æ— ç ´åæ€§å˜æ›´

### ç³»ç»Ÿæ¶æ„å›¾

```
ç”¨æˆ·è¾“å…¥å¤æ‚æŒ‡ä»¤
    â†“
å¤æ‚æŒ‡ä»¤æ£€æµ‹ (isComplexInstruction)
    â†“
è®¡åˆ’ç”Ÿæˆ (Gemini 2.0 Flash + generateObject)
    â†“
SSE å‘é€ 'plan' äº‹ä»¶
    â†“
å‰ç«¯æ˜¾ç¤º PlanPreviewCard
    â†“
ç”¨æˆ·ç¡®è®¤æ‰§è¡Œ
    â†“
æ‰§è¡Œå¼•æ“é¡ºåºæ‰§è¡Œ (executePlan)
    â”œâ”€ æ­¥éª¤1: è§£æå˜é‡ â†’ è°ƒç”¨å·¥å…· â†’ è®°å½•æ—¥å¿—
    â”œâ”€ æ­¥éª¤2: è§£æå˜é‡ â†’ è°ƒç”¨å·¥å…· â†’ è®°å½•æ—¥å¿—
    â””â”€ æ­¥éª¤N: è§£æå˜é‡ â†’ è°ƒç”¨å·¥å…· â†’ è®°å½•æ—¥å¿—
    â†“
SSE å‘é€ 'execution_complete' äº‹ä»¶
    â†“
å‰ç«¯æ˜¾ç¤ºæ‰§è¡Œç»“æœï¼ˆ3ç§’åè‡ªåŠ¨æ¸…é™¤ï¼‰
    â†“
æ•°æ®åº“æ›´æ–°å®Œæˆ
```

---

**ğŸš€ Plan-Then-Execute åŠŸèƒ½å·²å®Œå…¨å°±ç»ªï¼Œå¯æŠ•å…¥ç”Ÿäº§ä½¿ç”¨ï¼**
