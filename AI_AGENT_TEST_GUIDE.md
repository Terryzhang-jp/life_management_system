# AI Agent Plan-Then-Execute 测试指南

## ✅ 实施状态

- **后端**: Phase 1-4 完成 ✓
- **前端**: Phase 5 完成 ✓
- **当前**: Phase 6 - 端到端测试

---

## 🎯 如何测试

### 前置条件

1. ✅ 开发服务器运行中：`npm run dev`
2. ✅ 访问地址：http://localhost:3000
3. ✅ 导航到工作台页面（包含 ChatInterface 组件）

### 测试场景 1：生成执行计划

**目标**：测试复杂指令的计划生成功能

**步骤**：
1. 在聊天界面中启用"编辑模式"（点击右上角的锁图标）
2. 输入复杂多步骤指令，例如：
   ```
   先创建主任务"学习投资"，然后创建子任务"阅读投资书籍"，最后标记子任务完成
   ```
3. 发送消息

**预期结果**：
- ✅ 系统检测到复杂指令
- ✅ 显示蓝色的"执行计划"卡片
- ✅ 卡片显示计划总结和步骤列表
- ✅ 每个步骤显示描述和依赖关系（如果有）
- ✅ 显示"确认执行"和"取消"按钮

**计划示例输出**：
```
📋 执行计划

总结：创建主任务"学习投资"及子任务，并标记完成

步骤：
1. 创建主任务：学习投资
2. 创建子任务：阅读投资书籍
   依赖：步骤1
3. 标记任务为完成
   依赖：步骤2
```

---

### 测试场景 2：确认执行计划

**目标**：测试计划执行功能

**步骤**：
1. 在场景1生成计划后，点击"确认执行"按钮
2. 等待执行完成

**预期结果**：
- ✅ 按钮显示加载状态
- ✅ 计划卡片保持显示
- ✅ 执行完成后显示绿色的"执行成功"提示
- ✅ 显示执行结果摘要
- ✅ 3秒后自动清除结果提示

**成功示例**：
```
✅ 执行成功

成功执行 3 个步骤：
1. 创建主任务：学习投资 ✓
2. 创建子任务：阅读投资书籍 ✓
3. 标记任务为完成 ✓
```

---

### 测试场景 3：取消计划

**目标**：测试计划取消功能

**步骤**：
1. 生成执行计划（参考场景1）
2. 点击"取消"按钮

**预期结果**：
- ✅ 计划卡片立即消失
- ✅ 显示 toast 提示："已取消 - 执行计划已取消"
- ✅ 不执行任何任务操作

---

### 测试场景 4：执行失败处理

**目标**：测试错误处理

**步骤**：
1. 输入会导致失败的复杂指令，例如：
   ```
   创建子任务"测试"（故意不指定父任务ID，让执行失败）
   ```
2. 确认执行

**预期结果**：
- ✅ 显示红色的"执行失败"提示
- ✅ 显示具体的错误信息
- ✅ 计划卡片清除

**失败示例**：
```
❌ 执行失败

执行失败于步骤 1/2: 创建子任务
错误: parentId is required for sub tasks
```

---

## 🔍 复杂指令检测规则

系统会自动检测以下模式的复杂指令：

1. **顺序连接词**：
   - "先...然后..."
   - "先...再..."
   - "再...再..."

2. **多个逗号分隔**：
   - "创建任务A，创建任务B，创建任务C"

3. **操作组合**：
   - "完成...创建..."
   - "创建...完成..."
   - "创建...标记..."
   - "标记...创建..."

**示例**：
- ✅ "先创建任务A，然后标记它完成" → 触发 Plan-Then-Execute
- ✅ "创建任务A，创建任务B，创建任务C" → 触发 Plan-Then-Execute
- ❌ "创建任务A" → 不触发，使用单步骤流程

---

## 🧪 完整测试用例

### 用例 1：创建多个任务
```
输入：创建主任务"健身计划"，创建主任务"学习编程"，创建主任务"阅读计划"

预期计划：
1. 创建主任务：健身计划
2. 创建主任务：学习编程
3. 创建主任务：阅读计划
```

### 用例 2：创建任务层级结构
```
输入：先创建主任务"年度目标"，然后在下面创建子任务"Q1目标"，最后在Q1目标下创建子子任务"一月计划"

预期计划：
1. 创建主任务：年度目标
2. 创建子任务：Q1目标（依赖步骤1）
3. 创建子子任务：一月计划（依赖步骤2）
```

### 用例 3：混合操作
```
输入：先标记任务 ID:62 完成，创建新任务"发邮件"，标记完成，创建任务"等待反馈"

预期计划：
1. 标记任务 ID:62 为完成
2. 创建任务：发邮件
3. 标记刚创建的任务为完成（依赖步骤2）
4. 创建任务：等待反馈
```

---

## 📊 前端组件说明

### 新增组件

#### 1. PlanPreviewCard (`components/workspace/plan-preview-card.tsx`)
- **功能**：显示执行计划预览
- **样式**：蓝色卡片，类似 PendingActionCard
- **交互**：确认执行、取消

#### 2. ChatInterface 扩展
- **新增状态**：
  - `currentPlan` - 当前待确认的计划
  - `executionResult` - 执行结果
- **新增函数**：
  - `handleConfirmPlan()` - 确认执行计划
  - `handleCancelPlan()` - 取消计划
- **SSE 事件处理**：
  - `plan` - 接收生成的计划
  - `execution_complete` - 接收执行结果

---

## 🎨 UI 设计

### 计划卡片（蓝色）
```
┌─────────────────────────────────────┐
│ 📋 执行计划  需要你的确认            │
│                                     │
│ 创建任务A并标记完成，创建任务B      │
│                                     │
│ 1. 创建任务：A                      │
│ 2. 标记刚创建的任务为完成            │
│    → 依赖：步骤1                     │
│ 3. 创建任务：B                      │
│                                     │
│ [✓ 确认执行]  [✗ 取消]              │
└─────────────────────────────────────┘
```

### 执行成功（绿色）
```
┌─────────────────────────────────────┐
│ ✅ 执行成功                          │
│                                     │
│ 成功执行 3 个步骤：                  │
│ 1. 创建任务：A ✓                    │
│ 2. 标记任务为完成 ✓                 │
│ 3. 创建任务：B ✓                    │
└─────────────────────────────────────┘
```

### 执行失败（红色）
```
┌─────────────────────────────────────┐
│ ❌ 执行失败                          │
│                                     │
│ 执行失败于步骤 2/3: 标记任务为完成   │
│ 错误: Task not found                │
└─────────────────────────────────────┘
```

---

## 🐛 已知限制

1. **前端 UI 完成** ✅
   - 计划预览卡片已实现
   - 执行进度显示已实现
   - 确认/取消交互已实现

2. **错误恢复**
   - 当前：某个步骤失败，整个计划停止
   - 未来：可添加重试机制

3. **并发执行**
   - 当前：只支持顺序执行
   - 未来：可扩展并行执行独立步骤

4. **计划持久化**
   - 当前：计划只在内存中
   - 未来：可保存到数据库供后续查看

---

## ✅ 测试检查清单

### 后端功能 (终端测试完成 ✅ 2025-10-03)
- [x] 复杂指令检测 (`isComplexInstruction()`)
- [x] 计划生成 (`generatePlan()`)
- [x] 计划执行 (`executePlan()`)
- [x] 变量占位符解析 (`{{step1.data.id}}`)
- [x] SSE 事件发送 (`plan`, `execution_complete`)
- [x] 工具层调用 (`create_task`, `complete_task`, `update_task`)
- [x] 数据库更新验证
- [x] 错误处理机制

### 前端功能 (组件已实现 ✅)
- [x] 计划显示卡片 (PlanPreviewCard)
- [x] 步骤列表渲染
- [x] 依赖关系显示
- [x] 确认执行按钮
- [x] 取消按钮
- [x] 执行结果显示（成功/失败）
- [x] SSE 事件接收
- [x] Loading 状态管理
- [x] 自动清除结果（3秒）

### 端到端流程 (后端测试完成 ✅)
- [x] 系统检测复杂指令
- [x] 系统生成计划
- [x] 系统执行计划
- [x] 系统返回结果
- [x] 任务数据库正确更新

### 前端 UI 测试 (待浏览器验证 ⏳)
- [ ] 用户在浏览器中输入复杂指令
- [ ] 前端显示计划预览卡片
- [ ] 用户点击确认执行按钮
- [ ] 前端显示执行结果
- [ ] 验证 Toast 通知正常工作

---

## 🚀 下一步

1. **进行完整的端到端测试**
   - 使用上述测试用例进行测试
   - 验证所有功能正常工作

2. **修复发现的问题**
   - 记录测试中遇到的 bug
   - 逐个修复并重新测试

3. **优化用户体验**
   - 改进错误提示信息
   - 添加更多视觉反馈

4. **文档更新**
   - 更新 AI_AGENT_COMPLETE_SUMMARY.md
   - 添加使用示例和最佳实践

---

**准备开始测试！** 🎉
